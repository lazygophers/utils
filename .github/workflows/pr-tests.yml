name: PR Tests and Quality Checks

on:
  pull_request:
    branches: [master]
  workflow_dispatch: # Allow manual trigger with confirmation

permissions:
  contents: read
  security-events: write # Required for security scanning
  pull-requests: read    # Required for PR linting
  actions: read         # Required for downloading artifacts

env:
  GO_VERSION: '1.25'

jobs:
  # Job requires manual approval for PR execution
  approve-pr-tests:
    name: Approve PR Tests
    runs-on: lazy
    if: github.event_name == 'pull_request'
    environment: pr-approval # This environment requires manual approval
    steps:
      - name: Approval Required
        run: |
          echo "âœ… PR tests approved and ready to run"
          echo "This step requires manual approval in the GitHub UI"

  test-and-lint:
    name: Tests and Code Quality
    runs-on: lazy
    needs: approve-pr-tests
    if: always() && (needs.approve-pr-tests.result == 'success' || github.event_name == 'workflow_dispatch')

    steps:
      # ===== SETUP PHASE =====
      - name: Checkout code
        uses: actions/checkout@v5.1.2
        with:
          fetch-depth: 0

      # ===== PERSISTENT GO ENVIRONMENT =====
      - name: Setup Go Environment
        uses: ./../actions/setup-go
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: false
          cache-dependency-path: go.sum

      # ===== LINTING PHASE =====
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@1e7e51e771db61008b38414a730f564565cf7c20
        with:
          version: latest
          args: --timeout=10m --issues-exit-code=1

      # ===== SECURITY PHASE =====
      - name: Run security scan
        uses: ./../actions/security-scan
        with:
          timeout: '10m'
          fail-on-high-critical: 'true'

      # ===== TESTING PHASE =====
      - name: Run tests with coverage
        run: |
          echo "ðŸ§ª Running tests with coverage for PR validation..."
          mkdir -p docs/reports
          go test -coverprofile=docs/reports/coverage.out -covermode=atomic -timeout 5m $(go list ./... | grep -v -E "(pgp|cryptox|human)")
          go tool cover -html=docs/reports/coverage.out -o docs/reports/coverage.html

          # Get coverage percentage
          COVERAGE=$(go tool cover -func=docs/reports/coverage.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
          echo "ðŸ“Š Coverage: ${COVERAGE}%"
          echo "COVERAGE_PERCENT=${COVERAGE}" >> $GITHUB_ENV
          echo "âœ… All tests passed"

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@cb6530fbecd68d5f1ee7a3dcd113450ea8d5d6d4
        with:
          file: ./docs/reports/coverage.out
          flags: pr-tests
          name: codecov-pr
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

      - name: Verify coverage meets threshold
        run: |
          COVERAGE=${{ env.COVERAGE_PERCENT }}
          echo "ðŸ“Š Current coverage: ${COVERAGE}%"
          THRESHOLD=65
          if awk "BEGIN {exit !($COVERAGE < $THRESHOLD)}"; then
            echo "âš ï¸ Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
            echo "This PR may reduce overall code coverage"
          else
            echo "âœ… Coverage ${COVERAGE}% meets threshold ${THRESHOLD}%"
          fi

      - name: Generate coverage report for PR
        run: |
          echo "ðŸ“‹ Generating coverage report for PR..."
          echo "## ðŸ“Š Test Coverage Report" > pr-coverage-summary.md
          echo "" >> pr-coverage-summary.md
          echo "**Coverage for this PR:** ${{ env.COVERAGE_PERCENT }}%" >> pr-coverage-summary.md
          echo "" >> pr-coverage-summary.md
          echo "### Coverage by Package" >> pr-coverage-summary.md
          echo "" >> pr-coverage-summary.md
          echo '```' >> pr-coverage-summary.md
          go tool cover -func=docs/reports/coverage.out >> pr-coverage-summary.md
          echo '```' >> pr-coverage-summary.md
          echo "" >> pr-coverage-summary.md
          echo "### Coverage Threshold Check" >> pr-coverage-summary.md
          THRESHOLD=65
          if awk "BEGIN {exit !(${{ env.COVERAGE_PERCENT }} >= $THRESHOLD)}"; then
            echo "âœ… **Status**: Meets threshold ($THRESHOLD%)" >> pr-coverage-summary.md
          else
            echo "âš ï¸ **Status**: Below threshold ($THRESHOLD%)" >> pr-coverage-summary.md
          fi

      # ===== BUILD PHASE =====
      - name: Build project
        run: |
          echo "ðŸ”¨ Building project..."
          go build -v ./...
          echo "âœ… Build completed"

      # ===== PR SUMMARY =====
      - name: PR Test Summary
        run: |
          echo "## ðŸŽ¯ PR Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Linting**: Passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Security Scan**: Passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Tests**: Passed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Build**: Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage**: ${{ env.COVERAGE_PERCENT }}%" >> $GITHUB_STEP_SUMMARY
          THRESHOLD=65
          if awk "BEGIN {exit !(${{ env.COVERAGE_PERCENT }} >= $THRESHOLD)}"; then
            echo "**Status**: âœ… Meets threshold ($THRESHOLD%)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status**: âš ï¸ Below threshold ($THRESHOLD%)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Status**: Ready for review and merge" >> $GITHUB_STEP_SUMMARY