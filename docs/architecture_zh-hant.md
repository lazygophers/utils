# LazyGophers Utils - 架構文檔

## 🏗️ 概述

LazyGophers Utils 是一個全面的 Go 工具庫，專注於模組化、效能和開發者體驗。該庫遵循現代 Go 最佳實踐，包括廣泛使用泛型、原子操作和零拷貝優化。

## 📊 項目統計

- **總包數量**: 25 個獨立模組
- **程式碼行數**: 56,847 行
- **Go 檔案數**: 323 個
- **測試覆蓋率**: 85.8%
- **Go 版本**: 1.24.0+

## 🎯 設計原則

### 1. 模組化架構
每個包都設計為獨立模組，可以單獨匯入和使用，最小化依賴和二進位大小。

### 2. 效能優先方法
- 大量使用原子操作實現線程安全
- 儘可能使用無鎖演算法
- 記憶體對齊優化
- 使用 unsafe 操作實現零拷貝字串/位元組轉換
- 高頻操作的物件池

### 3. 型別安全
大量使用 Go 1.18+ 泛型提供型別安全的 API，同時保持效能。

### 4. 一致的錯誤處理
所有包都遵循一致的錯誤處理模式：使用 `github.com/lazygophers/log` 記錄錯誤後返回。

## 🏛️ 包架構

### 核心包
這些包構成了庫的基礎：

#### `utils` (根包)
- **用途**: 錯誤處理、資料庫操作和驗證的基礎工具
- **主要功能**:
  - `Must[T any](value T, err error) T` - 錯誤時 panic 的包裝器
  - `Scan()` 和 `Value()` - 資料庫整合工具
  - `Validate()` - 使用 go-playground/validator 的結構體驗證
- **依賴**: 最小外部依賴

#### `candy`
- **用途**: 全面的型別轉換和切片操作
- **規模**: 143 個檔案，15,963 行程式碼
- **主要函數**:
  - 型別轉換: `ToBool()`, `ToString()`, `ToInt*()`, `ToFloat*()`
  - 函數式程式設計: `All()`, `Any()`, `Filter()`, `Map()`
  - 切片工具: `Unique()`, `Sort()`, `Shuffle()`, `Chunk()`
- **效能**: 使用泛型優化型別安全

#### `json`
- **用途**: 帶效能優化的增強 JSON 操作
- **特性**:
  - 在支援的平台上使用 sonic 進行平台特定優化
  - 對不同 JSON 實現的一致 API 包裝
- **效能關鍵**: 是

### 基礎設施包

#### `runtime`
- **用途**: 執行時工具和系統資訊
- **主要功能**:
  - 全面的 panic 處理和恢復
  - 系統目錄工具 (`ExecDir()`, `UserHomeDir()` 等)
  - 平台檢測工具

#### `routine`
- **用途**: 增強的 goroutine 管理
- **特性**:
  - 帶 panic 恢復的安全 goroutine 執行
  - 使用 `github.com/petermattis/goid` 的 goroutine 追蹤
  - 自動清理和錯誤處理

#### `app`
- **用途**: 應用程式生命週期和建置資訊
- **特性**:
  - 建置元資料 (commit, branch, tag, build date)
  - 環境檢測
  - 版本資訊

### 工具包

#### `stringx`
- **用途**: 高效能字串操作
- **規模**: 11 個檔案，4,385 行程式碼
- **效能優化**:
  - 使用 unsafe 操作的零拷貝字串/位元組轉換
  - 大小寫轉換的 ASCII 快速路徑優化
  - 記憶體高效的字串操作
- **主要函數**:
  - `ToString()` / `ToBytes()` - 零拷貝轉換
  - `Camel2Snake()` - 優化的大小寫轉換
  - 帶效能優化的 Unicode 工具

#### `anyx`
- **用途**: 型別無關的 map 操作和值提取
- **規模**: 4 個檔案，3,999 行程式碼
- **主要功能**:
  - 帶型別轉換的線程安全 map 操作
  - 支援點號記法的巢狀鍵
  - 全面的型別提取工具
- **依賴**: 使用 `candy` 和 `json` 包

#### `wait`
- **用途**: 高級並發和同步工具
- **規模**: 6 個檔案，1,323 行程式碼
- **主要元件**:
  - `Async()` - 帶工作分發的 goroutine 池
  - `AsyncUnique()` - 並發處理中的任務去重
  - 帶附加功能的增強 WaitGroup
  - 效能優化的物件池

### 專業包

#### `cryptox`
- **用途**: 全面的加密操作
- **規模**: 40 個檔案，11,254 行程式碼
- **功能**:
  - 對稱加密: AES, DES, Triple DES, ChaCha20
  - 非對稱加密: RSA, ECDSA, ECDH
  - 雜湊: SHA 系列, MD5, HMAC, BLAKE2, SHA3
  - 金鑰衍生: PBKDF2, Scrypt, Argon2
- **安全性**: 遵循最佳實踐的生產就緒實現

#### `hystrix`
- **用途**: 高效能熔斷器模式實現
- **規模**: 4 個檔案，1,367 行程式碼
- **效能優化**:
  - 狀態管理的原子操作
  - 無鎖演算法
  - CPU 快取效率的記憶體對齊
  - 三種變體: 標準、快速和批次優化
- **基準測試**: 註冊操作約 46ns/op，零分配

#### `xtime`
- **用途**: 帶中國日曆支援的擴展時間操作
- **規模**: 21 個檔案，10,744 行程式碼
- **獨特功能**:
  - 中國農曆計算
  - 二十四節氣計算
  - 工作時間表的業務時間常量
  - 不同工作模式的子包 (007, 955, 996)

### 配置和 I/O 包

#### `config`
- **用途**: 多格式配置載入
- **支援格式**: JSON, YAML, TOML, INI, HCL
- **特性**: 帶驗證的環境感知配置載入

#### `bufiox`
- **用途**: 緩衝 I/O 操作和工具
- **特性**: 效能優化的自訂掃描工具

#### `osx`
- **用途**: 跨平台作業系統介面和檔案操作
- **規模**: 9 個檔案，2,554 行程式碼
- **功能**: 跨平台相容的檔案系統工具

### 網路和通訊

#### `network`
- **用途**: 網路工具和助手
- **特性**: IP 位址工具、介面檢測、真實 IP 提取

### 隨機和測試工具

#### `randx`
- **用途**: 擴展隨機數和資料生成
- **規模**: 9 個檔案，2,014 行程式碼
- **功能**:
  - 各種機率分佈
  - 基於時間的隨機工具
  - 效能優化的隨機產生器

#### `fake`
- **用途**: 測試用假資料生成
- **特性**: 使用者代理生成、測試資料工具

## 🔗 依賴圖

```
根包 (utils)
├── json (核心 JSON 操作)
├── candy (型別轉換)
└── ... (最小外部依賴)

基礎設施層
├── runtime → app
├── routine → runtime, log
└── osx (作業系統抽象)

工具層
├── stringx (字串操作)
├── anyx → candy, json
├── wait → routine, runtime
└── xtime (時間操作)

專業層
├── cryptox (加密操作)
├── hystrix → randx (熔斷器)
├── config → json, osx, runtime
└── network (網路工具)
```

## 🚀 效能特徵

### 基準測試 (Apple M3)

| 包 | 操作 | 效能 | 記憶體 |
|---------|-----------|-------------|--------|
| atexit | Register | 46.69 ns/op | 43 B/op, 0 allocs/op |
| atexit | RegisterConcurrent | 43.81 ns/op | 44 B/op, 0 allocs/op |
| atexit | ExecuteCallbacks | 545.9 ns/op | 896 B/op, 1 allocs/op |

### 效能特性

1. **無鎖操作**: 關鍵路徑使用原子操作而非互斥鎖
2. **記憶體對齊**: 結構體對齊以獲得最佳 CPU 快取效能
3. **零拷貝操作**: 字串/位元組轉換無記憶體分配
4. **物件池**: 減少高頻操作的 GC 壓力
5. **泛型優化**: 型別安全操作無執行時反射

## 🧪 測試和品質

### 按包的測試覆蓋率
- **candy**: 99.3%
- **anyx**: 99.0%
- **atexit**: 100.0%
- **bufiox**: 100.0%
- **cryptox**: 100.0%
- **defaults**: 100.0%
- **stringx**: 96.4%
- **osx**: 97.7%
- **config**: 95.7%
- **network**: 89.1%

### 品質保證
- 帶邊界情況覆蓋的全面單元測試
- 效能關鍵操作的基準測試
- 並發操作的競態條件測試
- 長時間執行操作的記憶體洩漏測試

## 🌏 文化特性

### 中國日曆支援 (xtime 包)
- **農曆**: 中國農曆的完整實現
- **節氣**: 24 個傳統中國節氣計算
- **工作時間表**: 支援中國工作模式 (007, 955, 996)
- **傳統節日**: 中國傳統節日計算

## 🔮 未來架構考慮

1. **外掛系統**: 考慮實現外掛架構以增強擴展性
2. **可觀測性**: 增強的指標和追蹤整合
3. **配置**: 熱重載配置功能
4. **快取**: 高效能場景的分散式快取層
5. **串流處理**: 大資料處理的增強串流工具

## 📈 可擴展性

該架構設計支援垂直和水平擴展：

- **垂直擴展**: 優化的記憶體使用和 CPU 效能
- **水平擴展**: 線程安全操作支援並發使用
- **微服務**: 每個包可以在不同服務中獨立使用
- **雲原生**: 相容容器環境和雲平台

這種架構為建構高效能 Go 應用程式提供了堅實的基礎，同時保持程式碼清晰和開發者生產力。